name: "Setup EcoScalpel CLI"
description: Install the EcoScalpel CLI for cost and sustainability analysis of Scaleway Terraform projects.
branding:
  icon: activity
  color: purple
inputs:
  install_dir:
    description: Directory where the EcoScalpel binary will be stored.
    default: ${{ runner.temp }}/ecoscalpel/bin
  api-key:
    description: EcoScalpel API key stored in the CLI config (masked).
    default: ""
  version:
    description: >
      EcoScalpel release version to install (e.g. v0.8.1). Use "latest" to pull
      the most recent GitHub release automatically.
    default: latest
outputs:
  ecoscalpel-path:
    description: Absolute path to the EcoScalpel binary.
    value: ${{ steps.build.outputs.cli_path }}
runs:
  using: composite
  steps:
    - name: Install EcoScalpel binary
      id: build
      shell: bash
      env:
        INSTALL_DIR: ${{ inputs.install_dir }}
        VERSION: ${{ inputs.version }}
      run: |
        set -euo pipefail

        install_dir="${INSTALL_DIR}"
        mkdir -p "$install_dir"

        owner="didier-segura"
        repo="ecoscalpel"
        version="${VERSION}"
        if [ "$version" = "latest" ]; then
          release_data="$(curl -fsSL "https://api.github.com/repos/$owner/$repo/releases/latest")"
          version="$(echo "$release_data" | jq -r '.tag_name')"
        else
          release_data="$(curl -fsSL "https://api.github.com/repos/$owner/$repo/releases/tags/$version")"
        fi
        if [ -z "$version" ] || [ "$version" = "null" ]; then
          echo "::error::Failed to determine EcoScalpel release version"
          exit 1
        fi
        if [ -z "${release_data:-}" ] || [ "$release_data" = "null" ]; then
          release_data="$(curl -fsSL "https://api.github.com/repos/$owner/$repo/releases/latest")"
        fi

        os="$(uname -s | tr '[:upper:]' '[:lower:]')"
        arch="$(uname -m)"
        case "$arch" in
          x86_64) arch="amd64" ;;
          aarch64|arm64) arch="arm64" ;;
          *) echo "::error::Unsupported architecture: $arch"; exit 1 ;;
        esac

        case "$arch" in
          amd64) arch_regex="(amd64|x86_64)";;
          arm64) arch_regex="(arm64|aarch64)";;
          *) arch_regex="$arch";;
        esac

        asset_url="$(echo "$release_data" | jq -r --arg os "$os" --arg arch_regex "$arch_regex" '
          [ .assets[]
            | select(.name | test($os; "i"))
            | select(.name | test($arch_regex; "i"))
            | select(.name | test("tar\\.gz$"))
            | .browser_download_url ][0]')"

        if [ -z "$asset_url" ] || [ "$asset_url" = "null" ]; then
          asset_url="$(echo "$release_data" | jq -r --arg os "$os" --arg arch_regex "$arch_regex" '
            [ .assets[]
              | select(.name | test($os; "i"))
              | select(.name | test($arch_regex; "i"))
              | .browser_download_url ][0]')"
        fi

        if [ -z "$asset_url" ] || [ "$asset_url" = "null" ]; then
          echo "::error::Could not find a release asset for OS=$os arch=$arch in $version"
          exit 1
        fi

        asset_name="$(basename "$asset_url")"

        tmp_dir="$(mktemp -d)"
        archive="$tmp_dir/$asset_name"
        echo "Downloading $asset_url"
        curl -fsSL "$asset_url" -o "$archive"

        case "$archive" in
          *.tar.gz|*.tgz) tar -xzf "$archive" -C "$tmp_dir" ;;
          *.zip) unzip -q "$archive" -d "$tmp_dir" ;;
          *) echo "::error::Unsupported archive format for $asset_name"; exit 1 ;;
        esac

        extracted_binary="$(find "$tmp_dir" -maxdepth 2 -type f -name 'ecoscalpel' | head -n1)"
        if [ -z "$extracted_binary" ]; then
          echo "::error::Downloaded archive did not contain ecoscalpel binary"
          exit 1
        fi
        mv "$extracted_binary" "$install_dir/ecoscalpel"

        chmod +x "$install_dir/ecoscalpel"
        echo "$install_dir" >> "$GITHUB_PATH"
        echo "cli_path=$(cd "$install_dir" && pwd)/ecoscalpel" >> "$GITHUB_OUTPUT"
